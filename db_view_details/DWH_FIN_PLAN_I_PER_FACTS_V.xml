<ClarityDBViewQuery>
  <QueryResult code="DWH_FIN_PLAN_I_PER_FACTS_V">
    <indexes/>
    <text_length>4978</text_length>
    <text>SELECT plan_detail_key,
       period_key,
       NVL(plan_units,0) plan_units,
       NVL(plan_cost,0) plan_cost,
       NVL(billing_plan_cost,0) billing_plan_cost,
       NVL(plan_revenue,0) plan_revenue,
       NVL(billing_plan_revenue,0) billing_plan_revenue,
       last_updated_date clarity_updated_date
FROM  (SELECT fpd.record_key plan_detail_key,
              p.id period_key,
              p.end_date - 1 period_finish,
              1 field,
              s.slice  * (CASE WHEN s.finish_date - 1 &lt; p.end_date - 1 THEN s.finish_date ELSE p.end_date END -
                          CASE WHEN s.start_date &lt; p.start_date THEN p.start_date ELSE s.start_date END) slice,
              fpd.last_updated_date
       FROM   dwh_tmp_fin_record_keys fpd
              INNER JOIN odf_ssl_cst_dtl_units s ON fpd.record_key = s.prj_object_id
              INNER JOIN biz_com_periods p ON p.entity_id = (SELECT entity_key FROM dwh_settings)
                                          AND p.period_type IN ('MONTHLY','13_PERIODS_PER_YEAR')
                                          AND s.start_date &lt; p.end_date
                                          AND s.finish_date > p.start_date
       UNION ALL 
       SELECT fpd.record_key plan_detail_key,
              p.id period_key,
              p.end_date - 1 period_finish,
              3 field,
              s.slice  * (CASE WHEN s.finish_date - 1 &lt; p.end_date - 1 THEN s.finish_date ELSE p.end_date END -
                          CASE WHEN s.start_date &lt; p.start_date THEN p.start_date ELSE s.start_date END) slice,
              fpd.last_updated_date 
       FROM   dwh_tmp_fin_record_keys fpd
              INNER JOIN odf_ssl_cst_dtl_cost s ON fpd.record_key = s.prj_object_id
              INNER JOIN biz_com_periods p ON p.entity_id = (SELECT entity_key FROM dwh_settings)
                                          AND p.period_type IN ('MONTHLY','13_PERIODS_PER_YEAR')
                                          AND s.start_date &lt; p.end_date
                                          AND s.finish_date > p.start_date
       UNION ALL
       SELECT fpd.record_key plan_detail_key,
              p.id period_key,
              p.end_date - 1 period_finish,
              5 field,
              s.slice  * (CASE WHEN s.finish_date - 1 &lt; p.end_date - 1 THEN s.finish_date ELSE p.end_date END -
                          CASE WHEN s.start_date &lt; p.start_date THEN p.start_date ELSE s.start_date END) slice,
              fpd.last_updated_date 
       FROM   dwh_tmp_fin_record_keys fpd
              INNER JOIN odf_ssl_cst_dtl_bcost s ON fpd.record_key = s.prj_object_id
              INNER JOIN biz_com_periods p ON p.entity_id = (SELECT entity_key FROM dwh_settings)
                                          AND p.period_type IN ('MONTHLY','13_PERIODS_PER_YEAR')
                                          AND s.start_date &lt; p.end_date
                                          AND s.finish_date > p.start_date
       UNION ALL
       SELECT fpd.record_key plan_detail_key,
              p.id period_key,
              p.end_date - 1 period_finish,
              6 field,
              s.slice  * (CASE WHEN s.finish_date - 1 &lt; p.end_date - 1 THEN s.finish_date ELSE p.end_date END -
                          CASE WHEN s.start_date &lt; p.start_date THEN p.start_date ELSE s.start_date END) slice,
              fpd.last_updated_date 
       FROM   dwh_tmp_fin_record_keys fpd
              INNER JOIN odf_ssl_cst_dtl_rev s ON fpd.record_key = s.prj_object_id
              INNER JOIN biz_com_periods p ON p.entity_id = (SELECT entity_key FROM dwh_settings)
                                          AND p.period_type IN ('MONTHLY','13_PERIODS_PER_YEAR')
                                          AND s.start_date &lt; p.end_date
                                          AND s.finish_date > p.start_date
       UNION ALL
       SELECT fpd.record_key plan_detail_key,
              p.id period_key,
              p.end_date - 1 period_finish,
              8 field,
              s.slice  * (CASE WHEN s.finish_date - 1 &lt; p.end_date - 1 THEN s.finish_date ELSE p.end_date END -
                          CASE WHEN s.start_date &lt; p.start_date THEN p.start_date ELSE s.start_date END) slice,
              fpd.last_updated_date 
       FROM   dwh_tmp_fin_record_keys fpd
              INNER JOIN odf_ssl_cst_dtl_brev s ON fpd.record_key = s.prj_object_id
              INNER JOIN biz_com_periods p ON p.entity_id = (SELECT entity_key FROM dwh_settings)
                                          AND p.period_type IN ('MONTHLY','13_PERIODS_PER_YEAR')
                                          AND s.start_date &lt; p.end_date
                                          AND s.finish_date > p.start_date)
       PIVOT (SUM(slice)
       FOR field IN (1 AS plan_units,
                     3 AS plan_cost,
                     5 AS billing_plan_cost,
                     6 AS plan_revenue,
                     8 AS billing_plan_revenue))</text>
  </QueryResult>
</ClarityDBViewQuery>
