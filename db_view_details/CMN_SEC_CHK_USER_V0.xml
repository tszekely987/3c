<ClarityDBViewQuery>
  <QueryResult code="CMN_SEC_CHK_USER_V0">
    <indexes/>
    <text_length>4524</text_length>
    <text>SELECT  /*+ index(G CMN_SEC_GROUPS_N1)  index(PARENT_GROUP CMN_SEC_GROUPS_N1) index(AP CMN_SEC_ASSGND_OBJ_PERM_N5)*/ -- Group Rule
        --  
        --  Note the use of the CMN_SEC_ASSGND_OBJ_PERM_N5 index above.  This works best in Oracle 11g, the reason being
        --  that the index has object_id and permission_id
        --
        UG.USER_ID,
        AP.OBJECT_ID,
        AP.OBJECT_INSTANCE_ID,
        PE.PERMISSION_CODE,
        PE.PERMISSION_VALUE
FROM    CMN_SEC_PERM_ELEMENTS PE,
        CMN_SEC_ASSGND_OBJ_PERM AP,
        CMN_SEC_GROUP_FLAT_HIERS H,
        CMN_SEC_USER_GROUPS UG,
        CMN_SEC_GROUPS G,
        CMN_SEC_GROUPS PARENT_GROUP
WHERE   UG.GROUP_ID = H.GROUP_ID
AND     H.GROUP_ID = G.ID
AND     G.IS_ACTIVE = 1
AND     AP.PRINCIPAL_ID = H.PARENT_GROUP_ID
AND     H.PARENT_GROUP_ID = PARENT_GROUP.ID
AND     PARENT_GROUP.IS_ACTIVE = 1
AND     AP.PRINCIPAL_TYPE = 'GROUP'
AND     AP.PERMISSION_ID = PE.PERMISSION_ID
UNION
SELECT   -- USER RULE
        AP.PRINCIPAL_ID USER_ID,
        AP.OBJECT_ID,
        AP.OBJECT_INSTANCE_ID,
        PE.PERMISSION_CODE,
        PE.PERMISSION_VALUE
FROM    CMN_SEC_PERM_ELEMENTS PE,
        CMN_SEC_ASSGND_OBJ_PERM AP         
WHERE   AP.PRINCIPAL_TYPE = 'USER'
AND     AP.PERMISSION_ID = PE.PERMISSION_ID
UNION -- OBS UNIT RULES for principal is user
SELECT 
        OS.PRINCIPAL_ID USER_ID,
        RI.OBJECT_ID,
        OU.INSTANCE_ID OBJECT_INSTANCE_ID,
        RI.PERMISSION_CODE,
        RI.PERMISSION_VALUE
FROM    CMN_SEC_ASSGND_RIGHT OS,
        CMN_SEC_RIGHT RI,
        OBS_UNIT_ENTITIES_V OU  
WHERE   OS.PRINCIPAL_TYPE = 'USER'
AND     OS.INSTANCE_TYPE = OU.UNIT_MODE
AND     OS.INSTANCE_ID = OU.UNIT_ID
AND     RI.RIGHT_ID = OS.RIGHT_ID
AND     RI.IS_ACTIVE = 1
AND     UPPER(OU.TABLE_NAME) = UPPER(RI.RIGHT_OBS_TYPE)
UNION 
--       OBS UNIT RULES for principal is group, note that this is changed and gets the right
--       first, this should be the smallest rows that can be easily determined.  The obvious
--       order which is user groups first causes issues when the user is a member of a lot of
--       groups.
SELECT 
        UG.USER_ID USER_ID,
        RI.OBJECT_ID,
        OU.INSTANCE_ID OBJECT_INSTANCE_ID,
        RI.PERMISSION_CODE,
        RI.PERMISSION_VALUE
FROM    CMN_SEC_RIGHT RI,
        CMN_SEC_ASSGND_RIGHT OS,
        CMN_SEC_USER_GROUPS UG,
        CMN_SEC_GROUPS G,
        OBS_UNIT_ENTITIES_V OU 
WHERE   OS.PRINCIPAL_TYPE = 'GROUP'
AND     OS.PRINCIPAL_ID = UG.GROUP_ID
AND     OS.INSTANCE_TYPE = OU.UNIT_MODE
AND     OS.INSTANCE_ID = OU.UNIT_ID
AND     G.ID = OS.PRINCIPAL_ID
AND     G.IS_ACTIVE = 1
AND     RI.IS_ACTIVE = 1
AND     UPPER(OU.TABLE_NAME) = UPPER(RI.RIGHT_OBS_TYPE)
AND     OS.RIGHT_ID = RI.RIGHT_ID
UNION  -- OBS UNIT RULES FOR PRINCIPAL IS OBS, to an instance
SELECT 
        OU.USER_ID USER_ID,
        RI.OBJECT_ID,
        OS.INSTANCE_ID OBJECT_INSTANCE_ID,
        RI.PERMISSION_CODE,
        RI.PERMISSION_VALUE
FROM    CMN_SEC_OBS_USERS_V OU,
        CMN_SEC_ASSGND_RIGHT OS,
        CMN_SEC_RIGHT RI
WHERE   OS.PRINCIPAL_TYPE = OU.UNIT_MODE
AND     OS.PRINCIPAL_ID = OU.UNIT_ID
AND     OS.INSTANCE_TYPE = 'INSTANCE'
AND     OS.RIGHT_ID = RI.RIGHT_ID
AND     RI.IS_ACTIVE = 1
UNION   -- OBS UNIT RULES FOR PRINCIPAL IS OBS, to whole OBS, the obs_unit_entities_v view is
        -- used here as it has the tables in the reverse order from the v2 view, this performs
        -- much better in most cases
        -- The index being force is what the 11g optimizer chooses given free reign, but when the
        -- table order is force (to the same order 11g uses) the index changes
SELECT /*+ index(RI CMN_SEC_RIGHT_U2) */
        res.USER_ID USER_ID,
        RI.OBJECT_ID,
        OU2.INSTANCE_ID OBJECT_INSTANCE_ID,
        RI.PERMISSION_CODE,
        RI.PERMISSION_VALUE
FROM    srm_resources res,
        prj_obs_associations oa,
        prj_obs_units ou,
        prj_obs_types ot,
        obs_units_flat_by_mode u,
        CMN_SEC_ASSGND_RIGHT OS,
        CMN_SEC_RIGHT RI,
        OBS_UNIT_ENTITIES_V OU2         
WHERE   u.linked_unit_id = oa.unit_id
and     UPPER(oa.table_name) = 'SRM_RESOURCES'
and     oa.record_id = res.id
and     oa.unit_id = ou.id
and     ou.type_id = ot.id
and     ot.is_security = 1
and     OS.PRINCIPAL_TYPE = u.UNIT_MODE
AND     OS.PRINCIPAL_ID = oa.UNIT_ID
AND     OS.INSTANCE_TYPE = OU2.UNIT_MODE
AND     OS.INSTANCE_ID = OU2.UNIT_ID
AND     OS.RIGHT_ID = RI.RIGHT_ID
AND     RI.IS_ACTIVE = 1
AND     UPPER(OU2.TABLE_NAME) = UPPER(RI.RIGHT_OBS_TYPE)</text>
  </QueryResult>
</ClarityDBViewQuery>
