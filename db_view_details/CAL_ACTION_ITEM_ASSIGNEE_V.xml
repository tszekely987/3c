<ClarityDBViewQuery>
  <QueryResult code="CAL_ACTION_ITEM_ASSIGNEE_V">
    <indexes/>
    <text_length>4177</text_length>
    <text>SELECT
    CAI.ID AS CAL_ACTION_ITEM_ID,
    (CASE WHEN CAI.MULTIPLE_ASSIGNEE = 0 THEN SINGLE_ASSIGNEE.ASSIGNEE_ID ELSE NULL END ) AS ASSIGNEE_ID,
    ( CASE WHEN CAI.MULTIPLE_ASSIGNEE = 0 THEN SINGLE_ASSIGNEE.LAST_NAME ELSE NULL END ) AS ASSIGNEE_LAST_NAME,
    ( CASE WHEN CAI.MULTIPLE_ASSIGNEE = 0 THEN SINGLE_ASSIGNEE.FIRST_NAME ELSE NULL END ) AS ASSIGNEE_FIRST_NAME,
    ( CASE WHEN CAI.MULTIPLE_ASSIGNEE = 0 THEN SINGLE_ASSIGNEE.FULL_NAME ELSE NULL END ) AS ASSIGNEE_FULL_NAME,
    ( CASE WHEN CAI.MULTIPLE_ASSIGNEE = 0 THEN SINGLE_ASSIGNEE.IS_PROXY ELSE NULL END ) AS IS_PROXY,
    ( CASE WHEN CAI.MULTIPLE_ASSIGNEE = 0 THEN SINGLE_ASSIGNEE.IS_ESCALATED ELSE NULL END ) AS IS_ESCALATED,
    ( CASE WHEN CAI.MULTIPLE_ASSIGNEE = 0 THEN SINGLE_ASSIGNEE.STATUS_CODE WHEN CAI.MULTIPLE_ASSIGNEE != 0 AND MULTI_ASSIGNEE.UNIQUE_STATUS_CODE_COUNT = 1 THEN MULTI_ASSIGNEE.UNIQUE_STATUS_CODE WHEN CAI.MULTIPLE_ASSIGNEE != 0 AND MULTI_ASSIGNEE.UNIQUE_STATUS_CODE_COUNT != 1 THEN 'CAL_OPEN' ELSE NULL END ) STATUS_CODE,
    COALESCE( SINGLE_ASSIGNEE.AI_SUBJECT, MULTI_ASSIGNEE.AI_SUBJECT, CAI.SUBJECT ) AS AI_SUBJECT,
    COALESCE( SINGLE_ASSIGNEE.AI_DESCRIPTION, MULTI_ASSIGNEE.AI_DESCRIPTION, CAI.DESCRIPTION ) AS AI_DESCRIPTION,
    COALESCE( SINGLE_ASSIGNEE.LAST_UPDATED_DATE, MULTI_ASSIGNEE.LAST_UPDATED_DATE, CAI.LAST_UPDATED_DATE ) AS LAST_UPDATED_DATE,
    (CASE WHEN CAI.PROCESS_HANDLER_ID > 0 THEN AO.ASSOC_OBJECT_ID ELSE CAI.OBJECT_ID END ) AS ASSOC_OBJECT_ID,
    (CASE WHEN CAI.PROCESS_HANDLER_ID > 0 THEN AO.ASSOC_OBJECT_CODE ELSE AIDEF.ASSOC_OBJECT_CODE END ) AS ASSOC_OBJECT_CODE,
    (CASE WHEN CAI.PROCESS_HANDLER_ID > 0 THEN AO.ASSOC_OBJECT_API_ALIAS ELSE AIDEF.ASSOC_OBJECT_API_ALIAS END ) AS ASSOC_OBJECT_API_ALIAS,
    CAI.AI_DEF_TYPE,
    CAI.AI_DEF_ID
FROM
    CAL_ACTION_ITEMS CAI
    /* SINGLE ASSIGNEE DETAILS */
    LEFT OUTER JOIN (
        SELECT
            CAL_ACTION_ITEM_ID,
            STATUS_CODE,
            CAIA.ASSIGNEE_ID,
            RES.LAST_NAME,
            RES.FIRST_NAME,
            RES.FULL_NAME,
            CAIA.IS_PROXY,
            CAIA.IS_ESCALATED,
            AI_SUBJECT AS AI_SUBJECT,
            AI_DESCRIPTION AS AI_DESCRIPTION,
            CAIA.LAST_UPDATED_DATE
        FROM
            CAL_ACTION_ITEM_ASSIGNEES CAIA
            LEFT OUTER JOIN SRM_RESOURCES RES ON RES.USER_ID = CAIA.ASSIGNEE_ID
    ) SINGLE_ASSIGNEE ON CAI.ID = SINGLE_ASSIGNEE.CAL_ACTION_ITEM_ID
    AND CAI.MULTIPLE_ASSIGNEE = 0
    AND SINGLE_ASSIGNEE.ASSIGNEE_ID IS NOT NULL
    /* MULTI ASSIGNEE DETAILS */
    LEFT OUTER JOIN (
        SELECT
            CAL_ACTION_ITEM_ID,
            COUNT(DISTINCT STATUS_CODE) AS UNIQUE_STATUS_CODE_COUNT,
            MAX(STATUS_CODE) AS UNIQUE_STATUS_CODE,
            MAX(AI_SUBJECT) AS AI_SUBJECT,
            MAX(AI_DESCRIPTION) AS AI_DESCRIPTION,
            MAX(LAST_UPDATED_DATE) AS LAST_UPDATED_DATE
        FROM
            CAL_ACTION_ITEM_ASSIGNEES
        GROUP BY
            CAL_ACTION_ITEM_ID
    ) MULTI_ASSIGNEE ON CAI.ID = MULTI_ASSIGNEE.CAL_ACTION_ITEM_ID
    /* PROCESS BASED ASSOCIATED OBJECT ACTION ITEMS */
    LEFT JOIN (
        SELECT
            O.OBJECT_ID ASSOC_OBJECT_ID,
            O.OBJECT_TYPE_CODE ASSOC_OBJECT_CODE,
            OC.api_alias ASSOC_OBJECT_API_ALIAS,
            AR.ID
        FROM
            BPM_RUN_STEPS S
            JOIN BPM_RUN_STEP_ACTION_RESULTS AR ON AR.STEP_INSTANCE_ID = S.ID
            JOIN BPM_RUN_OBJECTS O ON O.PK_ID = S.PROCESS_INSTANCE_ID
            AND AR.STEP_INSTANCE_ID = S.ID
            JOIN ODF_OBJECTS OC ON OC.CODE = O.OBJECT_TYPE_CODE
        WHERE
            O.SRC_TABLE_NAME IS NULL
            AND O.TABLE_NAME = 'BPM_RUN_PROCESSES'
            AND O.PARENT_OBJECT_ID IS NULL
            AND O.OBJECT_TYPE_CODE NOT IN ('process', 'actionitem')
    ) AO ON CAI.PROCESS_HANDLER_ID = AO.ID
    LEFT JOIN (
        SELECT
            DEF.ID ID,
            DEF.OBJECT_TYPE ASSOC_OBJECT_CODE,
            OC.API_ALIAS ASSOC_OBJECT_API_ALIAS
        FROM
            CMN_ACTION_ITEM_DEFS DEF
            JOIN ODF_OBJECTS OC ON OC.CODE = DEF.OBJECT_TYPE
    ) AIDEF ON AIDEF.ID = CAI.AI_DEF_ID and CAI.AI_DEF_TYPE = 'actionitemdef'</text>
  </QueryResult>
</ClarityDBViewQuery>
